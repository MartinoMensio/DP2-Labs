<?xml version="1.0" encoding="UTF-8"?>
<project name="NFFG-3 build service" default="build-service" basedir=".">
	<description>
		Script for building service for NFFG Assignment 3
	</description>

	<!-- The classpath to be used for compilation of the solution -->
	<path id="sol.classpath">
		<pathelement location="${lib.dir}/NFFG.jar" />
		<pathelement location="${lib.dir}/lab3.jar" />
		<pathelement location="${lib.dir}/javax.ws.rs-api-2.0.1.jar" />
		<pathelement location="${lib.dir}/jersey-client-1.19.1.jar" />
		<pathelement location="${lib.dir}/jersey-core-1.19.1.jar" />
	</path>

	<property name="src.dir" location="${basedir}/src" />
	<property name="custom.dir" value="${basedir}/custom" />
	<property name="build.dir" value="${basedir}/build" />
	<property name="schema.dir" value="${basedir}/xsd" />
	<property name="gen.dir" value="${basedir}/gen-src" />
	<property name="jaxb.dir" value="${gen.dir}/jaxb" />
	<property name="wjc.dir" value="${gen.dir}/wjc" />
	<property name="lib.dir" location="${basedir}/lib" />
	<property name="NEO4JURL" value="http://localhost:8080/Neo4JXML/rest" />
	<property name="WADL" value="${NEO4JURL}/application.wadl" />
	<property name="service.src.dir" value="${basedir}/src/it/polito/dp2/NFFG/sol3/service" />
	<property name="client1.src.dir" value="${basedir}/src/it/polito/dp2/NFFG/sol3/client1" />
	<property name="client2.src.dir" value="${basedir}/src/it/polito/dp2/NFFG/sol3/client2" />

	<target name="build-service" depends="compile-wjc,compile-jaxb,build-lab3">
		<!-- TODO -->
		<javac srcdir="${service.src.dir}" destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath" />
	</target>
	<target name="build-client" depends="compile-jaxb,build-lab3">
		<!-- TODO -->
		<javac srcdir="${client1.src.dir}" destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath" />
		<javac srcdir="${client2.src.dir}" destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath" />
	</target>
	<target name="clean">
		<delete dir="${jaxb.dir}" />
		<delete dir="${wjc.dir}" />
	</target>

	<target name="build-lab3">
		<javac destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath">
			<src path="${src.dir}" />
			<include name="it/polito/dp2/NFFG/lab3/**" />
			<exclude name="it/polito/dp2/NFFG/lab3/tests/**" />
		</javac>
	</target>

	<!-- TODO split in two directories the wjc and jaxb artifacts -->
	<target name="compile-wjc" depends="generate-wjc,generate-jaxb">
		<!-- Removing the file that has problems -->
		<!--<delete>
			<fileset dir="${wjc.dir}/it/polito/dp2/NFFG/sol3/service/wjc">
				<include name="Localhost_Neo4JXMLRest.java" />
			</fileset>
		</delete>-->
		<javac srcdir="${wjc.dir}" destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath" />
	</target>
	<target name="compile-jaxb" depends="generate-jaxb">
		<javac srcdir="${jaxb.dir}" destdir="${build.dir}" includeantruntime="false" classpathref="sol.classpath" />
	</target>


	<!-- Target chk-bindings -->
	<target name="-chk-jaxb">
		<uptodate property="generate-jaxb.notRequired" targetfile="${jaxb.dir}/.jaxb_flagfile">
			<srcfiles dir="${schema.dir}" includes="**/*.xsd" />
		</uptodate>
	</target>
	<!-- Target generate-bindings -->
	<target name="generate-jaxb" unless="generate-jaxb.notRequired" depends="-chk-jaxb" description="Generate bindings from schema">
		<mkdir dir="${jaxb.dir}" />
		<exec executable="xjc" failonerror="true">
			<arg value="-d" />
			<arg value="${jaxb.dir}" />
			<arg value="-p" />
			<arg value="it.polito.dp2.NFFG.sol3.service.jaxb" />
			<arg value="${schema.dir}/nffgVerifier.xsd" />
		</exec>
		<touch file="${jaxb.dir}/.jaxb_flagfile" />
	</target>

	<taskdef name="wjc" classname="org.jvnet.ws.wadl2java.WJCTask">
		<classpath>
			<fileset dir="${lib.dir}" includes="*.jar" />
		</classpath>
	</taskdef>
	<!-- Target chk-artifacts -->
	<target name="-chk-wjc">
		<uptodate property="generate-wjc.notRequired" targetfile="${wjc.dir}/.wjc_flagfile">
			<!-- regenerate artifacts if this build file is modified (or if the flagfile is removed) -->
			<srcfiles dir="${basedir}" includes="sol_build.xml" />
			<!-- update also in case some customization files are updated -->
			<srcfiles dir="${custom.dir}" includes="*.*" />
		</uptodate>
	</target>

	<!-- define the client artifacts generation target -->
	<target name="generate-wjc" depends="-chk-wjc" unless="generate-wjc.notRequired">
		<mkdir dir="${wjc.dir}" />
		<echo message="Compiling the WADL descriptions..." />
		<wjc target="${wjc.dir}" autoSchemaPackage="false" package="it.polito.dp2.NFFG.sol3.service.wjc" description="${WADL}">
			<produces dir="${wjc.dir}/it/polito/dp2/NFFG/sol3.service" includes="*.java" />
			<!-- if this file is modified with respect to the produces set, rebuild also if the wadl and xsd didn't change -->
			<depends dir="${basedir}" includes="sol_build.xml" />
			<!-- use customizations -->
			<customizations dir="${custom.dir}" includes="*.xjb" />
		</wjc>
		<touch file="${wjc.dir}/.wjc_flagfile" />
	</target>
</project>
